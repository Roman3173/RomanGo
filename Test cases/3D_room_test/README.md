
# Общие моменты.

Тестовое задание взято из [intern_test_3D_room](https://github.com/MindSetLib/intern_test_3D_room/blob/main/README.md).

Сделано: сгенерировано 6 изображений стен. Для пола и потолка выбранный алгоритм не подходит, о чём ниже.

До текущего момента не работал с трансформацией изображений. Впервые ознакомился с cv2, scikit-image, аффинным преобразование, преобразованием перспективы, remap, undistort, но сталкивался с Stable diffusion, blender, unreal engine. Для лучшего результата было бы неплохо с моей стороны в несколько итераций апскейла и денойза поднять качество как исходного изображения, так и промежуточных, так и результирующих, но, во-первых, это противоречило изначальному заданию (из задания: "Input: Любая комбинация исходных данных," -- комбинация исходных данных, а не сторонним образом трансформированных исходных данных), также об этой возможности вспомнил только на заключительных этапах.

# Результаты

Итоговый файл:
* [на github](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/test_case_3d_ml.ipynb)
* [в colab](https://colab.research.google.com/drive/1zMSA0aMD3OwbxOPrGKNUVHgwC-UhW5Gs?usp=sharing)

Workplace:
* [на github](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/test_case_workplace_3d_ml.ipynb)
* [в colab](https://colab.research.google.com/drive/19CSsmhJel0JG9v9Q2FeyvvogV64lkStO?usp=sharing)

[0 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/0_proj.jpg) -- самая длинная.

[1 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/1_proj.jpg) -- с окнами.

[2 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/2_proj.jpg) -- закуток рядом с окном.

[3 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/3_proj.jpg) -- самая узкая.

[4 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/4_proj.jpg) -- с дверьми лифта.

[5 стена](https://github.com/Roman3173/RomanGo/blob/main/Test%20cases/3D_room_test/5_proj.jpg) -- дальняя с дверью.

Итоговое время исследования и построения решения: ~44 часа.

# Описание исследований.

Все файлы так или иначе применялись в работе.

Первым приоритетом было воссоздание изображений стен (6 стен важнее 2 изображений пола и потолка). Исследование начал с исследования файла depth_map. Так как вертикальные углы задавались всего 2 точками предположил, что для стен горизонтальное искажение равномерно для каждой вертикальной линии шириной в пиксель. Постарался построить нормаль к каждой из стен (нормаль к 3 и 4 стене построить не удалось, лежат вне области стены, решил проблему эмпирически (см. логи за 9 февраля)). Также построил высоту к каждой вертикальной линии (шириной в пиксель) по всей длине изображения. Точки оснований высот образовали фактически горизонтальную прямую линию на высоте y = 255 (всего на 32 из 1024 результат отличался и походил на артефакты изображения).

Также проверил высоту стен по вертикальным углам по двум формулам: через знание 2 сторон треугольника и высоты, а также через знание 2 сторон и медианы (результаты более менее совпали). Все углы, кроме одного показали 2.8 метра, что не соответствовало заведённому в задании значению 2.5. С учётом этого искажения подошёл к подсчёту длины стен:
* 0 стена оказалась на 10% больше реального значения.
* 1 стена на 20% больше.
* 2 стена на 30% меньше.
* 3 и 4 не получилось опеределить.
* 5 стена на 5% меньше.

Для определения итоговых изображений применил комбинированное кусочное-перспективное преобразование:
1. Привести изображение каждой стены к одной высоте по пиксельно по оси "x". Делал в 2 этапа: ниже линии высоты от точки обзора к стенам (y = 255) и выше этой линии.
2. Кусочно растянуть изображение в соответствии с горизонтальным искажением (степень искажения искал, отталкиваясь от нормали к стене и расстояния до основания высоты конкретной вертикальной линии стены a^2 = c^2 - b^2):
    * сначала найти степень растяжения и размер результирующего изображения;
    * создать маску растянутого изображения;
    * кусочно нанести растянутые части изначального изображения на маску.
3. Применить resize к предыдущему изображению.

Всё вышеперечисленное на промежуточных этапах можно дополнить денойзом и апскейлом из, допустим, Stable diffusion. Причины, почему не применил, описал выше.

К сожалению, этот метод не подошёл для пола и потолка. В отстутсвие времени на дополнительные изыскания (срок тестового задания подошёл к концу), отправляю "как есть". Сделаю предположение, что подойдут undistort или remap. Также понимаю, что как пол, так и потолок нужно разбить на 5-6 частей каждый, преобразовать каждую из них, после чего нанести на итоговое изображение.

# Логи выполнения задания.

| Рабочий период | Затраченное время | Что делал |
| :---         |     :---      |          :--- |
| 2024.02.02 14:59-15:42 | 1 час | Знакомство с заданием, с cv2, загрузка. Начало поиска технологии под предложенные данные. |
| 2024.02.02 18:45-22:45 | 4 часа | Поиск подхода к решению задачи. |
| 2024.02.03 12:30-14:40 | 2 часа | Как результат исследования предложенных данных -- повторение изображения из задания (с крестиками в углах помещения и линиями по граням стен). Также определил по карте глубины внутренние значения высоты потолка, которое не соответствовало заявленным 2.5 метра. Учёл этот момент. |
| 2024.02.04 20:35 -23:40 | 3 часа | Исследование предложенных chat GPT решений, таких как: Трансформация перспективы, Афинное преобразование. Закончил с мыслью, что нужно пробовать cv2.remap. |
| 2024.02.05 8:00-11:45 | 4 часа | Исследование Piecewise Affine Transformation в [scikit-image](https://scikit-image.org/docs/stable/auto_examples/transform/plot_piecewise_affine.html), которое, как казалось, производило нужное преобразование. Столкнулся с тем, что один и тот же код работает в VS code (jupyter notebook) и не работает в Colab. Что-то поменялось во внутренних библиотеках и в: tform = PiecewiseAffineTransform(); tform.estimate(src, dst) -- estimate отказывается работать 'Delaunay' object has no attribute 'vertices'|
| 2024.02.05 20:40-21:50 | 1 час | Продолжение попыток запустить в Colab (на разных версиях scikit-image), но по неизвестной причине не завелось. Перекатился в VS code. На момент окончания исследования выдавало чёрный экран. |
| 2024.02.07 16:00-23:30 | 7 часов | Исследованию разных трансформаций изображений. До конца не разобрался в кусочно-аффинном, undistort и remap. Результаты не удовлетворительные, перспективы решить с помощью undistort -- самые высокие. Так как определить сроки успешного завершения исследования любого из этих трёх способов я не смог, но был гарантированный вариант как минимум для стен, приступил к нему: к комбинированному кусочно-перспективному преобразованию.|
| 2024.02.08 8:30-12:20 | 4 часов | Сформировал первый вариант 1-ой стены. Исправил несколько ошибок, приступил к комментированию workplace и формированию итогового colab-документа. |
| 2024.02.08 17:00-22:40 | 6 часов | Нашёл несколько ошибок и неточностей, улучшил решение, сформировал решение для 2-ой стены. |
| 2024.02.09 16:00-01:00 | 9 часов | Столкнулся с проблемой странных Depth на 4-ой стене (которая 40 см в ширину). Продолжительные попытки найти нормаль к 4-ой стене выявили, что в оценке глубины в файле depth-map присутствует некая значительная погрешность. В итоге решил проблему эмпирическим путём, применил знания к построению изображения 5-ой стены. Также приступил к подбиванию результатов в единый документ на github. |
| 2024.02.10 10:30-13:10 | 3 часов | Продолжил подбивать результаты тестового. |
